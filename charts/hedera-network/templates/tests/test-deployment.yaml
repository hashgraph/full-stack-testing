apiVersion: v1
kind: Pod
metadata:
  name: "network-test"
  annotations:
    "helm.sh/hook": test
    # add hook-failed once bug is fixed that prevents it from getting logs
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  serviceAccountName: pod-monitor
  volumes:
    - name: test-volume
      configMap:
        name: test-cm
        defaultMode: 0777 # we need the test files to be executable
  containers:
    {{- $tester := $.Values.tester }}
    - name: tester
      image: {{ include "fullstack.container.image" (dict "image" $tester.image "Chart" $.Chart "defaults" $tester) }}
      imagePullPolicy: {{ include "fullstack.images.pullPolicy" (dict "image" $tester.image "defaults" $tester) }}
      {{- with $tester.resources }}
      resources:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      volumeMounts:
        - mountPath: /tests
          name: test-volume
      env:
        - name: TESTS_DIR
          value: "/tests" # should be same as mountPath
      command:
        - "/bin/bash"
        - "-c"
        - /tests/run.sh
        #- "while true;do echo sleeping; sleep 10;done"
  restartPolicy: Never
